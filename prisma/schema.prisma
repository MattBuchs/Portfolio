generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Plan {
  FREE
  PRO
  BUSINESS
}

model License {
  id              String   @id @default(cuid())
  email           String
  licenseKey      String   @unique // Clé chiffrée
  licenseSecret   String   // Secret chiffré
  plan            Plan     @default(FREE)
  maxUsages       Int      // Nombre maximum d'utilisations
  remainingUsages Int      // Nombre d'utilisations restantes
  sessionId       String   @unique // ID de session Stripe
  machineIds      String[] // Liste des IDs de machines
  customerName    String?
  company         String?
  price           Float?   // Prix payé (après réduction)
  originalPrice   Float?   // Prix original avant réduction
  promoCode       String?  // Code promo utilisé
  discount        Float?   // Montant de la réduction appliquée
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([sessionId])
  @@index([licenseKey])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model PromoCode {
  id              String       @id @default(cuid())
  code            String       @unique
  discountType    DiscountType
  discountValue   Float        // Pourcentage (ex: 20 pour 20%) ou montant fixe (ex: 10 pour 10€)
  maxUses         Int?         // Nombre maximum d'utilisations (null = illimité)
  usedCount       Int          @default(0)
  validFrom       DateTime     @default(now())
  validUntil      DateTime?    // Date d'expiration (null = pas d'expiration)
  isActive        Boolean      @default(true)
  applicablePlans Plan[]       // Plans auxquels ce code s'applique (vide = tous)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([code])
}

model PlanPricing {
  id              String   @id @default(cuid())
  plan            Plan     @unique
  basePrice       Float    // Prix de base
  currentPrice    Float    // Prix actuel
  isOnSale        Boolean  @default(false)
  saleEndDate     DateTime? // Date de fin de la promotion
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model AppVersion {
  id            String   @id @default(cuid())
  version       String   @unique // ex: "1.0.0"
  fileName      String   // ex: "GameMasterOS_Setup.exe"
  fileSize      BigInt   // Taille en bytes
  releaseDate   DateTime @default(now())
  releaseNotes  String   // Notes de version en Markdown
  isLatest      Boolean  @default(false) // Une seule version peut être latest
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isLatest])
  @@index([releaseDate])
}
